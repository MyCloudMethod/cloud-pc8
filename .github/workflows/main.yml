name: Windows-RDP-UE5

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: 🚀 Start Setup Log
      run: echo "✅ Mulai setup VM + RustDesk + UE5 CLI + Tools..."

    - name: 🛠️ Cek & Install Chocolatey (hindari warning)
      shell: powershell
      run: |
        if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
          Set-ExecutionPolicy Bypass -Scope Process -Force
          iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        } else {
          Write-Output "✅ Chocolatey sudah terinstall, lanjut..."
        }

    - name: 📦 Install Software
      shell: powershell
      run: |
        $ErrorActionPreference = 'Continue'
        choco install googlechrome -y --no-progress
        choco install vscode -y --no-progress
        choco install obs-studio -y --no-progress
        choco install 7zip -y --no-progress
        choco install git -y --no-progress

    - name: 🧠 Cek Spesifikasi Hardware
      shell: powershell
      run: |
        Write-Output "`n🧠 CPU:"
        wmic cpu get Name,NumberOfCores,MaxClockSpeed

        Write-Output "`n📂 RAM:"
        systeminfo | findstr /C:"Total Physical Memory"

        Write-Output "`n🎮 GPU:"
        Get-WmiObject Win32_VideoController | Select-Object Name, AdapterRAM

        Write-Output "`n📍 SSD:"
        Get-PSDrive -PSProvider 'FileSystem' | Where-Object {$_.Free -gt 0} | Select-Object Name, Free, Used, @{Name='Total';Expression={$_.Free + $_.Used}}

        Write-Output "`n🪟 Windows:"
        systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

    - name: 🎮 Clone Unreal Engine (opsional)
      shell: powershell
      continue-on-error: true
      run: |
        Write-Output "⬇️ Clone UE5 repo (butuh akses GitHub EpicGames)"
        git clone https://github.com/EpicGames/UnrealEngine.git ue5

    - name: 🖥️ Install dan Jalankan RustDesk
      shell: powershell
      run: |
        $url = "https://github.com/rustdesk/rustdesk/releases/download/1.2.3/rustdesk-1.2.3-windows_x64.zip"
        $output = "rustdesk.zip"

        Invoke-WebRequest -Uri $url -OutFile $output

        Expand-Archive -Path $output -DestinationPath rustdesk

        Start-Process -FilePath ".\rustdesk\rustdesk.exe" -ArgumentList "--password ${{ secrets.RUSTDESK_PWD }} --id ${{ secrets.RUSTDESK_ID }}" -NoNewWindow

    - name: 🔓 Buka Port 8080
      shell: powershell
      run: |
        netsh advfirewall firewall add rule name="Port 8080" dir=in action=allow protocol=TCP localport=8080

    - name: ⏱️ Keep Alive 6 Jam
      shell: cmd
      run: timeout /t 21600
