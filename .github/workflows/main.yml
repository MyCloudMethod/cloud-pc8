name: Windows-RDP-UE5

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360  # Max GitHub limit (6 jam)

    steps:
    - name: ğŸš€ Start Log
      run: echo "âœ… Memulai setup VM dengan RustDesk, UE5, dan tools..."

    - name: ğŸ› ï¸ Cek & Install Chocolatey (No Warning)
      run: |
        if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        } else {
            echo "âœ… Chocolatey sudah terinstall, lanjut..."
        }

    - name: ğŸ“¦ Install Software (VSCode, OBS, dll)
      run: |
        choco install -y googlechrome vscode obs-studio 7zip git

    - name: ğŸ§  Cek Hardware (CPU, RAM, GPU, SSD, OS)
      run: |
        echo "`nğŸ§  CPU:"
        wmic cpu get Name,NumberOfCores,MaxClockSpeed

        echo "`nğŸ’¾ RAM:"
        systeminfo | findstr /C:"Total Physical Memory"

        echo "`nğŸ® GPU:"
        Get-WmiObject Win32_VideoController | Select-Object Name, AdapterRAM

        echo "`nğŸ’½ SSD:"
        Get-PSDrive -PSProvider 'FileSystem' | Where-Object {$_.Free -gt 0} | Select-Object Name, Free, Used, @{Name='Total';Expression={$_.Free + $_.Used}}

        echo "`nğŸªŸ OS:"
        systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

    - name: ğŸ® Unreal Engine CLI Clone (Optional)
      run: |
        echo "â¬‡ï¸ Clone Unreal Engine repo (butuh akses GitHub EpicGames)"
        echo "âš ï¸ Ini placeholder. Full UE5 build butuh token & setup manual."
        git clone https://github.com/EpicGames/UnrealEngine.git ue5 || echo "â— Gagal clone, token mungkin belum ada."

    - name: ğŸ–¥ï¸ Install & Jalankan RustDesk
      run: |
        Invoke-WebRequest -Uri "https://github.com/rustdesk/rustdesk/releases/latest/download/rustdesk-1.2.3-windows_x64.zip" -OutFile "rustdesk.zip"
        Expand-Archive rustdesk.zip -DestinationPath rustdesk
        Start-Process -FilePath ".\rustdesk\rustdesk.exe" -ArgumentList "--password ${{ secrets.RUSTDESK_PWD }} --id ${{ secrets.RUSTDESK_ID }}" -NoNewWindow

    - name: ğŸ”“ Open Port (Contoh: 8080)
      run: |
        netsh advfirewall firewall add rule name="Port 8080" dir=in action=allow protocol=TCP localport=8080

    - name: â±ï¸ Keep Alive 6 Jam
      run: timeout /t 21600

    # Optional: Trigger ulang otomatis (jika kamu buat personal token)
    #- name: ğŸ” Auto Restart (optional - butuh GH_TOKEN)
    #  run: gh workflow run windows-rdp.yml
